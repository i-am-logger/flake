name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  validate-and-check:
    name: Validate & Check
    runs-on:
      - flake
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        
      - name: Check Nix formatting
        run: |
          echo "Checking Nix file formatting..."
          if command -v nixpkgs-fmt &> /dev/null; then
            nixpkgs-fmt --check .
          else
            echo "Using nixpkgs-fmt from nixpkgs..."
            nix run nixpkgs#nixpkgs-fmt -- --check .
          fi
        
      - name: Validate flake structure
        run: |
          echo "Validating flake.nix syntax..."
          nix flake show --json > /dev/null
          
      - name: Check flake metadata
        run: |
          echo "Checking flake metadata..."
          nix flake metadata
          
      - name: List all outputs
        run: |
          echo "Listing all flake outputs..."
          nix flake show
        
      - name: Run flake check
        run: |
          echo "Running flake check..."
          nix flake check --all-systems

  build-systems:
    name: Build Systems
    runs-on:
      - flake
    needs: validate-and-check
    strategy:
      matrix:
        system: [yoga, skyspy-dev]
      fail-fast: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        
      - name: Build ${{ matrix.system }} configuration (dry-run)
        run: |
          echo "Dry-run building ${{ matrix.system }} system..."
          nix build .#nixosConfigurations.${{ matrix.system }}.config.system.build.toplevel --dry-run
          echo "✓ Dry-run successful - configuration is buildable"

  evaluate-systems:
    name: Evaluate Configurations
    runs-on:
      - flake
    needs: build-systems
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Nix
        uses: ./.github/actions/setup-nix
        
      - name: Evaluate yoga configuration
        run: |
          echo "Evaluating yoga configuration..."
          nix eval .#nixosConfigurations.yoga.config.system.name
          nix eval .#nixosConfigurations.yoga.config.networking.hostName
          
      - name: Evaluate skyspy-dev configuration
        run: |
          echo "Evaluating skyspy-dev configuration..."
          nix eval .#nixosConfigurations.skyspy-dev.config.system.name
          nix eval .#nixosConfigurations.skyspy-dev.config.networking.hostName

  summary:
    name: Pipeline Summary
    runs-on:
      - flake
    needs: [validate-and-check, build-systems, evaluate-systems]
    if: always()
    
    steps:
      - name: Display results
        run: |
          echo "=== CI/CD Pipeline Summary ==="
          echo "Validate & Check: ${{ needs.validate-and-check.result }}"
          echo "Build Systems: ${{ needs.build-systems.result }}"
          echo "Evaluate Systems: ${{ needs.evaluate-systems.result }}"
          
          if [ "${{ needs.validate-and-check.result }}" = "success" ] && \
             [ "${{ needs.build-systems.result }}" = "success" ] && \
             [ "${{ needs.evaluate-systems.result }}" = "success" ]; then
            echo ""
            echo "✓ All checks passed!"
            exit 0
          else
            echo ""
            echo "✗ Some checks failed"
            exit 1
          fi
