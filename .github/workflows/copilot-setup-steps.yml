name: copilot-setup-steps

on:
  workflow_dispatch:

jobs:
  copilot-setup-steps:
    runs-on: flake
    container:
      image: nixos/nix:latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_SERVER_URL: ${{ github.server_url }}
      GITHUB_API_URL: ${{ github.api_url }}
      GITHUB_GRAPHQL_URL: ${{ github.graphql_url }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends wget xz-utils ca-certificates curl git
          sudo update-ca-certificates || true

      - name: Setup Node.js for MCP servers
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set GitHub host for CodeQL
        run: |
          echo "GITHUB_HOST=github.com" >> $GITHUB_ENV
          echo "✓ Set GITHUB_HOST=github.com"
      
      - name: Install required tools
        run: |
          set -e
          echo "Installing required tools..."
          
          # Install CodeQL
          echo "Installing CodeQL for Copilot coding agent..."
          CODEQL_VERSION="2.15.5"
          CODEQL_HOME="/opt/hostedtoolcache/CodeQL/${CODEQL_VERSION}/x64"
          
          sudo mkdir -p "${CODEQL_HOME}"
          wget -q "https://github.com/github/codeql-action/releases/download/codeql-bundle-v${CODEQL_VERSION}/codeql-bundle-linux64.tar.gz"
          sudo tar -xzf codeql-bundle-linux64.tar.gz -C "${CODEQL_HOME}" --strip-components=1
          rm codeql-bundle-linux64.tar.gz
          sudo chmod -R 755 "${CODEQL_HOME}"
          echo "${CODEQL_HOME}/codeql" >> $GITHUB_PATH
          
          echo "✓ CodeQL installed successfully"
          echo "✓ Node.js version: $(node --version)"
          echo "✓ npm version: $(npm --version)"
      
      - name: Test self-hosted runner
        run: |
          echo "✓ Running on self-hosted ARC runner"
          echo "Hostname: $(hostname)"
          echo "Runner: $(whoami)"
          echo "Working directory: $(pwd)"
