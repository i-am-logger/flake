name: Release

on:
  push:
    branches: [ master, main ]

jobs:
  build-runner-image:
    name: Build GitHub Runner Image
    runs-on: flake
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Nix
        uses: ./.github/actions/setup-nix
      
      - name: Build runner image
        run: |
          echo "Building GitHub Actions runner image..."
          nix build .#github-runner-image
      
      - name: Test runner image
        run: |
          echo "Testing GitHub Actions runner image..."
          nix build .#checks.x86_64-linux.github-runner-test
      
      - name: Load image into Docker
        run: |
          echo "Loading image into Docker..."
          docker load < result
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Tag and push pre-release image
        run: |
          # Tag with commit SHA for pre-release
          docker tag github-runner:nixos-latest ghcr.io/i-am-logger/github-runner:sha-${{ steps.sha.outputs.short }}
          docker push ghcr.io/i-am-logger/github-runner:sha-${{ steps.sha.outputs.short }}
          
          # Also push as 'edge' for latest main build
          docker tag github-runner:nixos-latest ghcr.io/i-am-logger/github-runner:edge
          docker push ghcr.io/i-am-logger/github-runner:edge
          
          echo "Pre-release image published:"
          echo "  - ghcr.io/i-am-logger/github-runner:sha-${{ steps.sha.outputs.short }}"
          echo "  - ghcr.io/i-am-logger/github-runner:edge"

  build-installer:
    name: Build Installer ISO
    runs-on: flake
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Nix
        uses: ./.github/actions/setup-nix
      
      - name: Build installer ISO
        run: |
          echo "Building installer ISO..."
          nix build .#installer-iso
      
      - name: Get short SHA
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      
      - name: Upload installer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer-iso-sha-${{ steps.sha.outputs.short }}
          path: result/iso/*.iso
          retention-days: 30

  release:
    needs: [build-runner-image, build-installer]
    runs-on: flake
    permissions:
      contents: write
      pull-requests: write
      packages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Nix
        uses: ./.github/actions/setup-nix
      
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Enable auto-merge for Release PR
        if: steps.release.outputs.pr
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(echo '${{ steps.release.outputs.pr }}' | jq -r '.number')
          echo "Waiting for validation checks to start..."
          sleep 10
          
          # Enable auto-merge - will merge once all required checks pass
          gh pr merge "$PR_NUMBER" --squash --auto || true
          
          echo "Auto-merge enabled. PR will merge automatically once checks pass."
      
      - name: Build and publish release runner image
        if: ${{ steps.release.outputs.release_created }}
        env:
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
        run: |
          echo "Release created: $TAG_NAME"
          echo "Building and publishing release runner image..."
          
          # Build the image
          nix build .#github-runner-image
          
          # Load into Docker
          docker load < result
          
          # Log in to GHCR
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # Tag with version and latest
          docker tag github-runner:nixos-latest ghcr.io/i-am-logger/github-runner:${TAG_NAME}
          docker tag github-runner:nixos-latest ghcr.io/i-am-logger/github-runner:latest
          
          # Push both tags
          docker push ghcr.io/i-am-logger/github-runner:${TAG_NAME}
          docker push ghcr.io/i-am-logger/github-runner:latest
          
          echo "Release runner image published:"
          echo "  - ghcr.io/i-am-logger/github-runner:${TAG_NAME}"
          echo "  - ghcr.io/i-am-logger/github-runner:latest"
      
      - name: Build and publish release installer ISO
        if: ${{ steps.release.outputs.release_created }}
        env:
          TAG_NAME: ${{ steps.release.outputs.tag_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Building installer ISO for release $TAG_NAME..."
          
          # Build the installer ISO
          nix build .#installer-iso
          
          # Find the ISO file
          ISO_FILE=$(find result/iso -name '*.iso' -type f | head -n 1)
          ISO_NAME=$(basename "$ISO_FILE")
          
          echo "Uploading installer ISO to release: $ISO_NAME"
          
          # Upload to GitHub release
          gh release upload "$TAG_NAME" "$ISO_FILE" --clobber
          
          echo "Release installer ISO published:"
          echo "  - $ISO_NAME attached to release $TAG_NAME"
