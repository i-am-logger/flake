name: Test Self-Hosted Runner

on:
  workflow_dispatch:
  push:
    branches:
      - integration-work
    paths:
      - '.github/workflows/test-runner.yml'

jobs:
  test-runner:
    name: Test Self-Hosted Runner
    runs-on: host-yoga-repo-flake
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: System information
        run: |
          echo "ğŸ–¥ï¸  Hostname: $(hostname)"
          echo "ğŸ§ OS: $(uname -a)"
          echo "ğŸ’¾ Disk space:"
          df -h / /nix /persist
          echo ""
          echo "ğŸ§  Memory:"
          free -h
          echo ""
          echo "ğŸ”§ Nix version:"
          nix --version
      
      - name: Check GPU availability
        run: |
          if command -v rocm-smi &> /dev/null; then
            echo "ğŸ® AMD GPU detected:"
            rocm-smi
          elif command -v nvidia-smi &> /dev/null; then
            echo "ğŸ® NVIDIA GPU detected:"
            nvidia-smi
          else
            echo "â„¹ï¸  No GPU tools found (rocm-smi or nvidia-smi)"
          fi
      
      - name: Docker availability
        run: |
          echo "ğŸ³ Docker version:"
          docker --version
          echo ""
          echo "ğŸ³ Docker info:"
          docker info
      
      - name: Nix build test
        run: |
          echo "ğŸ”¨ Testing Nix build capability..."
          nix-build -E '(import <nixpkgs> {}).hello'
      
      - name: Runner labels
        run: |
          echo "ğŸ·ï¸  This runner has the following labels:"
          echo "  - self-hosted"
          echo "  - host-$(hostname)"
          echo "  - repo-flake"
      
      - name: Success message
        run: |
          echo "âœ… Self-hosted runner test completed successfully!"
          echo "ğŸ‰ Runner is working properly on $(hostname)"
