#!/usr/bin/env bash

# Ultra-low latency audio visualization for 240Hz monitors
# Optimized for minimal processing delay

exec 2>/dev/null  # Suppress all stderr

# Pre-build character lookup for maximum speed
declare -A char_map=(
    ['0']='▁' ['1']='▂' ['2']='▃' ['3']='▄'
    ['4']='▅' ['5']='▆' ['6']='▇' ['7']='█'
)

# Ultra-fast conversion function
convert_bars() {
    local line="$1" bars="" char
    
    # Direct character mapping for speed
    for (( i=0; i<${#line}; i++ )); do
        char="${line:$i:1}"
        bars+="${char_map[$char]:-▁}"
    done
    
    printf '%s\n' "$bars"
}

# Optimized cava execution with minimal buffering
exec 3< <(exec cava -p ~/.config/eww/cava-config)
while IFS= read -r line <&3; do
    [[ -n "$line" ]] && convert_bars "$line"
done
