#!/usr/bin/env bash

# Ultra-fast 240Hz audio visualizer
# Optimized for minimal latency and maximum responsiveness

# Pre-compiled character mapping for speed
declare -A charmap=(
    ['0']='▁' ['1']='▂' ['2']='▃' ['3']='▄'
    ['4']='▅' ['5']='▆' ['6']='▇' ['7']='█'
)

# Ultra-fast conversion with minimal overhead
process_line() {
    local line="$1" output="" char
    for (( i=0; i<${#line}; i++ )); do
        char="${line:$i:1}"
        output+="${charmap[$char]:-▁}"
    done
    printf '%s\n' "$output"
}

# Use unbuffered I/O for maximum speed
exec 3< <(stdbuf -o0 cava -p ~/.config/eww/cava-config 2>/dev/null)
while IFS= read -r line <&3; do
    [[ -n "$line" ]] && process_line "$line"
done
