#!/bin/bash

# Stream cava output continuously for eww deflisten
# This script runs once and outputs data continuously

# Function to cleanup on exit
cleanup() {
    pkill -f "cava.*cava-working.conf" 2>/dev/null
    exit 0
}

# Set up cleanup on script exit
trap cleanup EXIT INT TERM

# Output initial state immediately
echo "▁▁▁▁▁▁▁▁▁▁"

# Start cava and process its output
nix-shell -p cava --run "cava -p /tmp/cava-working.conf" 2>/dev/null | while read -r line; do
    # Take only the first 10 bars for eww display
    bars=""
    count=0
    for val in $line; do
        if [ $count -ge 10 ]; then
            break
        fi
        case $val in
            0|1) bars+="▁" ;;
            2) bars+="▂" ;;
            3) bars+="▃" ;;
            4) bars+="▄" ;;
            5) bars+="▅" ;;
            6) bars+="▆" ;;
            7) bars+="▇" ;;
            *) bars+="█" ;;
        esac
        ((count++))
    done
    echo "$bars"
    # Force flush output
    exec 1>&1
done
